export const maxDuration = 90;
export const runtime = 'nodejs';

export async function POST(req: Request) {
    try {
        if (!process.env.OPENROUTER_API_KEY) {
            return Response.json({ error: 'Key OpenRouter belum terpasang' }, { status: 500 });
        }

        const { prompt } = await req.json();

        if (!prompt) {
            return new Response(JSON.stringify({ error: "Prompt is required" }), { status: 400 });
        }

        // OpenRouter Model Selection
        // Validating Model ID from user suggestion and search
        const modelId = "openai/gpt-5-image-mini";
        console.log("Using Model ID for Image Generation:", modelId);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 85000); // 85s timeout for 90s maxDuration

        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": "http://localhost:3000",
                    "X-Title": "AI Chef Indonesia"
                },
                body: JSON.stringify({
                    model: modelId,
                    messages: [
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    modalities: ["image", "text"],
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            const data = await response.json();
            // Log mentah untuk kita amati di terminal VS Code
            console.log("=== DEBUG OPENROUTER RESPONSE ===");
            console.log(JSON.stringify(data, null, 2));

            if (data.error) {
                console.error("OPENROUTER API ERROR:", JSON.stringify(data.error, null, 2));
                return new Response(JSON.stringify({ error: data.error.message || "Failed to generate image via OpenRouter" }), { status: 500 });
            }

            let imageUrl = "";

            // Jalur 1: Standard Chat Completion (choices[0].message.content)
            if (data.choices?.[0]?.message?.content) {
                const content = data.choices[0].message.content;
                const match = content.match(/\bhttps?:\/\/[^\s"']+/gi);
                imageUrl = match ? match[0] : "";
                if (imageUrl) console.log("✅ URL Found via Jalur 1 (Regex Content)");
            }

            // Jalur 2: Standard Image API (data[0].url)
            if (!imageUrl && data.data?.[0]?.url) {
                imageUrl = data.data[0].url;
                console.log("✅ URL Found via Jalur 2 (data.url)");
            }

            // Jalur 3: Nested Data (data.images?.[0])
            if (!imageUrl && data.images?.[0]) {
                imageUrl = data.images[0];
                console.log("✅ URL Found via Jalur 3 (data.images)");
            }

            if (!imageUrl) {
                // Jika tetap gagal, berikan error yang sangat detail di terminal
                console.error("❌ PARSING FAILED. Cek struktur RAW RESPONSE di atas.");
                return Response.json({ error: "Format URL tidak dikenal", raw: data }, { status: 500 });
            }

            console.log("SUCCESSFULLY EXTRACTED URL:", imageUrl);
            return Response.json({ url: imageUrl });

        } catch (fetchError: any) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
                return new Response(JSON.stringify({ error: "Request ke OpenRouter timeout (60s)." }), { status: 500 });
            }
            throw fetchError;
        }

    } catch (error: any) {
        console.error("OPENROUTER IMAGE GENERATION ERROR:", error.stack || error);
        return new Response(JSON.stringify({ error: error.message || "Gagal membuat gambar." }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
        });
    }
}
